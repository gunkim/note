---
tags:
  - 대규모시스템설계기초1-4장
---
각 알고리즘의 자바로 구현된 코드는 [이곳](https://github.com/gunkim/java-code-kata/tree/main/rate-limiter)에서  볼 수 있다.
## 토큰 버킷
- 요청이 들어오면 토큰이 존재한다면 처리된다.  
- 토큰이 부족하다면 거부된다.  
- 일정 시간마다 토큰을 버킷 크기만큼 리필한다.    
- 구현이 쉬우며 많은 기업이 이용하고 있다. 하지만 안정적인 처리를 보장하진 못한다.  
- 예를 들어, 초반에 트래픽이 몰려 모든 토큰이 소비된다면 이후 요청은 토큰이 리필될 때까지 처리되지 못한다.
## 누출  버킷
- 요청이 들어오면 Queue에 요청을 적재 (보통 Queue 사이즈는 버킷 사이즈)  
- Queue가 가득 찼다면 요청은 Drop (대기시키도록 구현도 고려해볼 순 있음  
- 일정 시간마다 일정량을 처리
- 고정된 처리율로 안정적인 트래픽 처리엔 좋지만, 트래픽이 몰리게 되면 요청이 버려질 수 있음.
## 고정 윈도우
- 고정된 간격의 윈도 내의 요청은 지정된 임계치 만큼 처리한다.  
- 임계치를 넘어선 요청은 새 윈도가 열릴 때까지 버려진다.'
- 윈도 경계 부근에 순간적으로 많은 트래픽이 집중된다면 할당된 임계치보다 많은 요청이 처리될 수 있는 문제가 있다.  
- 예를 들어,  
	- 윈도 크기가 1분이고 임계치가 100이라고 가정할 때,  
	- 12:00:30에 100개의 요청이 처리되고,  
	- 12:01:00에 윈도가 새로 열리면서 다시 100개의 요청이 처리될 수 있다.  
	- 이러한 경우 12:00:30에서 12:01:00 사이에 200개의 요청이 처리된 것이다.
> 구현 방식은 그냥 현재 시간을 고정된 간격(windowSize)으로 나눈 후 카운팅하여 임계치를 넘었는지 판단하는 생각보다 간단한 방식이다.
## 슬라이딩 윈도우
- 슬라이딩 윈도우 기법을 사용하여 고정된 간격의 윈도 내에서 요청을 제한한다.  
- 현재 윈도와 이전 윈도의 요청을 샘플링하고, 가중치를 부여하여 전체 요청 수를 계산한다.  
- 임계치를 넘어선 요청은 거부된다.  
- 이 방식을 사용하면 윈도 경계에서의 집중된 트래픽 문제를 완화할 수 있다.  
- 예를 들어,  
	- 윈도 크기가 1분이고 임계치가 100이라고 가정할 때,  
	- 12:00:30에서 12:01:30까지의 1분간의 요청 중 일부는 새로운 윈도로 넘어가서 가중치를 부여받는다. 
	- 이는 고정된 윈도우 카운터에서 발생할 수 있는 200개의 요청이 처리되는 문제를 감소시킨다.
> 카운터 값 = 고정 윈도 방식 + (가중치)
> 위의 가중치를 포함한 현재 윈도의 카운터 값을 기반으로 임계치를 계산하는 방식이다.
### 가중치 계산 공식
가중치=previousCounter×(1−elapsedRatio)
- `previousCounter`는 이전 윈도우의 요청 수
- `elapsedRatio`는 현재 윈도우에서 경과된 시간 비율